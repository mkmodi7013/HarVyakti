<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile | HarVyakti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/profile.css">
</head>
<body>

<header class="top-bar">
  <h2>Profile</h2>
  <a href="dashboard.html">‚¨Ö Dashboard</a>
  <button id="logoutBtn">Logout</button>
</header>

<main class="container">
  <div class="card">

    <!-- BASIC INFO -->
    <label>Name</label>
    <input type="text" id="name" placeholder="Enter your name">

    <label>Email</label>
    <input type="email" id="email" disabled>

    <!-- ROLES -->
    <label>Roles</label>
    <div id="roles">
      <p class="muted">Loading roles...</p>
    </div>

    <!-- CONTACT -->
    <label>Mobile</label>
    <input id="mobile" placeholder="Mobile">

    <label>Address</label>
    <input id="address" placeholder="Address">

    <!-- LOCATION -->
    <button type="button" id="setLocation">üìç Set Location</button>
    <p id="locStatus" class="muted"></p>

    <!-- SAVE -->
    <button type="button" id="saveBtn">Save Profile</button>

  </div>
</main>

<!-- ‚úÖ JS SAME FILE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getDatabase,
  ref,
  get,
  update
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* üî• Firebase Config */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT"
};

/* Init */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* Elements */
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const mobileInput = document.getElementById("mobile");
const addressInput = document.getElementById("address");
const rolesDiv = document.getElementById("roles");
const saveBtn = document.getElementById("saveBtn");
const setLocationBtn = document.getElementById("setLocation");
const locStatus = document.getElementById("locStatus");
const logoutBtn = document.getElementById("logoutBtn");

let uid = null;
let currentLocation = null;

/* üîê Auth Guard */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "auth.html";
    return;
  }

  uid = user.uid;
  emailInput.value = user.email;

  loadProfile(uid);
});

/* üîπ Load profile */
async function loadProfile(uid) {
  const snap = await get(ref(db, "users/" + uid));
  if (!snap.exists()) return;

  const data = snap.val();

  nameInput.value = data.name || "";
  mobileInput.value = data.mobile || "";
  addressInput.value = data.address || "";

  // Roles
  rolesDiv.innerHTML = "";
  if (data.roles && data.roles.length) {
    data.roles.forEach(r => {
      const span = document.createElement("span");
      span.className = "role";
      span.innerText = r;
      rolesDiv.appendChild(span);
    });
  } else {
    rolesDiv.innerHTML = "<p class='muted'>No roles selected</p>";
  }

  if (data.location) {
    currentLocation = data.location;
    locStatus.innerText = "üìç Location already saved";
  }
}

/* üìç Set Location */
setLocationBtn.addEventListener("click", () => {
  locStatus.innerText = "Fetching location...";
  if (!navigator.geolocation) {
    locStatus.innerText = "Geolocation not supported";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      currentLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      locStatus.innerText = "üìç Location set successfully";
    },
    () => {
      locStatus.innerText = "Location permission denied";
    }
  );
});

/* üíæ Save Profile */
saveBtn.addEventListener("click", async () => {
  if (!uid) return;

  try {
    await update(ref(db, "users/" + uid), {
      name: nameInput.value.trim(),
      mobile: mobileInput.value.trim(),
      address: addressInput.value.trim(),
      location: currentLocation || null
    });
    alert("Profile saved successfully");
  } catch (e) {
    alert(e.message);
  }
});

/* üö™ Logout */
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "auth.html";
});
</script>

</body>
</html>
