<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Works | HarVyakti</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:'Segoe UI',Tahoma,sans-serif; min-height:100vh; display:flex; flex-direction:column; }
header { position:fixed; top:0; left:0; width:100%; background:linear-gradient(90deg,#4facfe,#00f2fe); box-shadow:0 4px 8px rgba(0,0,0,.2); z-index:1000; }
.header-container { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:15px 20px; }
.logo { font-size:1.8rem; font-weight:bold; color:white; cursor:pointer; letter-spacing:1px; }
nav a { color:white; text-decoration:none; margin-left:25px; font-weight:600; }
main { flex:1; padding:100px 20px 20px; text-align:center; }
footer { background-color:#1c1c1c; color:white; text-align:center; padding:15px 0; margin-top:auto; }
h2{text-align:center}
.work-card{background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
.status{font-weight:bold; color:green;}
button{padding:8px 12px; background:#1976d2; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-top:10px;}
button:disabled{background:#aaa;}
.empty{text-align:center; color:#666; margin-top:40px;}
.status-badge{
  padding:4px 8px;
  border-radius:4px;
  font-weight:600;
  color:#fff;
}
.status-open{ background:#1976d2; }
.status-accepted{ background:#f57c00; }
.status-completed{ background:#2e7d32; }

.rating-box{
  margin-top:10px;
}
.rating-box select{
  padding:6px;
}

</style>
</head>

<body>
<header>
<div class="header-container">
<div class="logo">HarVyakti</div>
<nav>
<a href="index.html">Home</a>
<a href="dashboard.html">Dashboard</a>
</nav>
</div>
</header>

<h2>My Works</h2>
<div id="worksContainer"></div>
<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, query, where, orderBy, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const worksContainer = document.getElementById("worksContainer");
let currentUser = null;

onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="login.html"; return; }
  currentUser = user;
  await loadMyWorks();
});

async function loadMyWorks(){
  worksContainer.innerHTML = "Loading...";
  try {
    const q = query(
      collection(db,"works"),
      where("postedBy","==",currentUser.uid),
      orderBy("createdAt","desc")
    );
    const snap = await getDocs(q);
    worksContainer.innerHTML = "";

    if(snap.empty){
      worksContainer.innerHTML = '<div class="empty">No works found</div>';
      return;
    }

    for(const d of snap.docs){
      const w = d.data();
      const div = document.createElement("div");
      div.className = "work-card";

      let buttonHtml = "";
      let acceptedHtml = "";

      /* ---------- ACCEPTED STATUS ---------- */
      if(w.status === "accepted"){
        let accepterInfo = { name:"Unknown", mobile:"" };

        if(w.acceptedBy){
          try{
            const userSnap = await getDoc(doc(db,"users",w.acceptedBy));
            if(userSnap.exists()){
              const data = userSnap.data();
              accepterInfo.name = data.name || "Unknown";
              accepterInfo.mobile = data.mobile || "";
            }
          }catch(e){ console.error(e); }
        }

        acceptedHtml = `
          <p><b>Accepted By:</b> ${accepterInfo.name}</p>
          <p><b>Mobile:</b> ${accepterInfo.mobile}
            <a href="tel:${accepterInfo.mobile}">
              <button>Call</button>
            </a>
          </p>

          <div class="rating-box">
            <label><b>Give Rating:</b></label>
            <select id="rating-${d.id}">
              <option value="">Select</option>
              <option value="1">⭐ 1</option>
              <option value="2">⭐⭐ 2</option>
              <option value="3">⭐⭐⭐ 3</option>
              <option value="4">⭐⭐⭐⭐ 4</option>
              <option value="5">⭐⭐⭐⭐⭐ 5</option>
            </select>
          </div>
        `;

        buttonHtml = `<button onclick="markCompleted('${d.id}')">Mark as Completed</button>`;
      }

      /* ---------- COMPLETED STATUS ---------- */
      if(w.status === "completed"){
        acceptedHtml = `
          <p><b>Accepted By:</b> ${w.acceptedByName || "Worker"}</p>
          <p><b>Rating Given:</b> ${w.rating || "N/A"} ⭐</p>
          <p style="color:#2e7d32;"><b>Mobile hidden after completion</b></p>
        `;
      }

      /* ---------- OPEN STATUS ---------- */
      if(w.status === "open"){
        buttonHtml = `<button onclick="deleteWork('${d.id}')">Delete Work</button>`;
      }

      div.innerHTML = `
        <h3>${w.title}</h3>
        <p>${w.description}</p>
        <p><b>Amount:</b> ₹${w.amount}</p>

        <p>
          <b>Status:</b>
          <span class="status-badge status-${w.status}">
            ${w.status}
          </span>
        </p>

        ${acceptedHtml}
        ${buttonHtml}
      `;

      worksContainer.appendChild(div);
    }
  } catch(err){
    console.error(err);
    worksContainer.innerHTML = "Error loading works";
  }
}


window.markCompleted = async (workId)=>{
  const ratingSelect = document.getElementById(`rating-${workId}`);
  const rating = ratingSelect?.value;

  if(!rating){
    alert("Please give rating before completing work");
    return;
  }

  if(!confirm("Mark this work as completed?")) return;

  try{
    await updateDoc(doc(db,"works",workId), {
      status:"completed",
      rating: Number(rating)
    });

    alert("Work completed & rating saved!");
    loadMyWorks();
  }catch(e){
    alert("Failed: " + e.message);
  }
};


window.deleteWork = async (workId)=>{
  if(!confirm("Are you sure you want to delete this work?")) return;
  try{
    await deleteDoc(doc(db,"works",workId));
    alert("Work deleted!");
    loadMyWorks();
  } catch(e){ alert("Failed: "+e.message); }
};
</script>



<footer>&copy; 2025 HarVyakti. All rights reserved.</footer>
</body>
</html>
