<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nearby Users | HarVyakti</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f2f4f7;padding-top:120px;}
header{position:fixed;top:0;left:0;width:100%;background:linear-gradient(90deg,#4facfe,#00f2fe);box-shadow:0 4px 8px rgba(0,0,0,0.2);z-index:1000;}
.header-container{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:15px 20px;}
.logo{color:#fff;font-size:1.8rem;font-weight:bold;}
nav a{color:#fff;text-decoration:none;margin-left:25px;font-weight:600;}
main{max-width:1000px;margin:0 auto;padding:20px;}
h2{margin-bottom:10px;}
.controls{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
.controls select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;font-size:14px;}
.card{padding:18px 22px;border-radius:14px;margin-bottom:15px;position:relative;color:#fff;cursor:pointer;transition:.3s;}
.card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15);}
.card .distance{display:none;font-size:13px;margin-top:6px;opacity:.9;}
.card:hover .distance{display:block;}
.role-name{font-weight:700;font-size:16px;}
.role-count{font-size:13px;opacity:0.9;margin-bottom:4px;}
.empty{color:#64748b;text-align:center;margin-top:40px;font-style:italic;}
</style>
</head>
<body>

<header>
  <div class="header-container">
    <div class="logo">HarVyakti</div>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="index.html">Home</a>
    </nav>
  </div>
</header>

<main>
  <h2>Nearby Users by Role</h2>

  <div class="controls">
    <select id="roleFilter">
      <option value="">All Roles</option>
    </select>
   <select id="distanceFilter">
  <option value="0.1">Within 100 m</option>
  <option value="1">Within 1 km</option>
  <option value="5">Within 5 km</option>
  <option value="10" selected>Within 10 km</option>
  <option value="20">Within 20 km</option>
  <option value="50">Within 50 km</option>
  <option value="100">Within 100 km</option>
  <option value="500">Within 500 km</option>
  <option value="1000">Within 1000 km</option>
  <option value="2000">Within 2000 km</option>
  <option value="5000">Within 5000 km</option>
</select>

  </div>

  <div id="list">Loading nearby usersâ€¦</div>
</main>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const list = document.getElementById("list");
const roleFilter = document.getElementById("roleFilter");
const distanceFilter = document.getElementById("distanceFilter");

let myUid = null;
let myLocation = null;
let usersData = {};
let allRoles = new Set();

onAuthStateChanged(auth, async user => {
  if(!user){ location.href="login.html"; return; }
  myUid = user.uid;

  await loadUsers();
  await loadMyLocation();
  populateRoleFilter();
  renderNearbyUsers();
});

async function loadUsers() {
  const usersSnap = await getDocs(collection(db, "users"));
  usersData = {};

  usersSnap.forEach(d => {
    const data = d.data();
    if(!data.location) return;
    usersData[d.id] = {
      location: { lat: parseFloat(data.location.lat), lng: parseFloat(data.location.lng) },
      roles: data.roles || []
    };
    data.roles?.forEach(r=>allRoles.add(r));
  });
}

async function loadMyLocation() {
  const snap = await getDoc(doc(db, "users", myUid));
  if(!snap.exists() || !snap.data().location){
    myLocation = { lat:0, lng:0 };
    list.innerHTML = "<p class='empty'>Set your location in profile to see nearby users</p>";
    return;
  }
  myLocation = { lat: parseFloat(snap.data().location.lat), lng: parseFloat(snap.data().location.lng) };
}

function populateRoleFilter(){
  roleFilter.innerHTML="<option value=''>All Roles</option>";
  allRoles.forEach(r=>{
    const option = document.createElement("option");
    option.value = r;
    option.textContent = r;
    roleFilter.appendChild(option);
  });
}

function renderNearbyUsers(){
  const maxDist = parseFloat(distanceFilter.value);
  const selectedRole = roleFilter.value;

  const filteredUsers = [];
  const roleCount = {};

  list.innerHTML = "";

  Object.keys(usersData).forEach(uid=>{
    if(uid===myUid) return;
    const u = usersData[uid];
    const dist = getDistance(myLocation.lat,myLocation.lng,u.location.lat,u.location.lng);
    if(dist>maxDist) return;

    u.roles.forEach(r=>{
      if(selectedRole && r!==selectedRole) return; // role filter

      filteredUsers.push({uid, role:r, dist});
      roleCount[r] = (roleCount[r] || 0) + 1;
    });
  });

  if(filteredUsers.length===0){
    list.innerHTML="<p class='empty'>No nearby users found</p>";
    return;
  }

  // sort by distance
  filteredUsers.sort((a,b)=>a.dist-b.dist);

  filteredUsers.forEach(u=>{
    const bgColor = `rgba(37,99,235,0.5)`; // simple color
    const card = document.createElement("div");
    card.className="card";
    card.style.backgroundColor = bgColor;
    card.innerHTML = `
      <div class="role-name">${u.role}: ${roleCount[u.role]}</div>
      <div class="distance">Distance: ${u.dist.toFixed(2)} km</div>
    `;
    list.appendChild(card);
  });
}

roleFilter.onchange = renderNearbyUsers;
distanceFilter.onchange = renderNearbyUsers;

// Haversine formula
function getDistance(lat1, lon1, lat2, lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
</script>

</body>
</html>
