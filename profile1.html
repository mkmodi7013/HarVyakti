<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Profile | HarVyakti</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary:#2563eb;
  --secondary:#0ea5e9;
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  padding-top:80px;
}
header{
  position:fixed;top:0;width:100%;
  background:linear-gradient(90deg,var(--primary),var(--secondary));
  box-shadow:0 6px 20px rgba(0,0,0,.15);
}
.header-container{
  max-width:1200px;margin:auto;
  padding:14px 24px;
  display:flex;justify-content:space-between;align-items:center;
}
.logo{color:#fff;font-size:1.7rem;font-weight:800}
nav a{color:#fff;text-decoration:none;margin-left:24px;font-weight:600}
main{max-width:760px;margin:auto;padding:24px}
.card{
  background:#fff;border-radius:18px;
  padding:28px 32px;
  box-shadow:0 20px 40px rgba(15,23,42,.08);
}
label{display:block;margin-top:18px;font-weight:600}
input{
  width:100%;margin-top:6px;
  padding:12px;border-radius:10px;
  border:1px solid var(--border)
}
.roles-box{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:12px;
}
.role{
  padding:12px;border-radius:12px;
  border:1px solid var(--border);
  display:flex;gap:10px;align-items:center;
}
button{
  margin-top:24px;width:100%;
  padding:14px;border:none;border-radius:14px;
  background:linear-gradient(90deg,var(--primary),var(--secondary));
  color:#fff;font-weight:700;font-size:16px;
}
#msg{margin-top:12px;text-align:center;color:var(--muted)}
</style>
</head>

<body>

<header>
  <div class="header-container">
    <div class="logo">HarVyakti</div>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="index.html">Home</a>
    </nav>
  </div>
</header>

<main>
<div class="card">
<h2>My Profile</h2>

<label>Name</label>
<input id="name">

<label>Email</label>
<input id="email" disabled>

<label>Mobile</label>
<input id="mobile">

<label>Address</label>
<input id="address">

<label>Location</label>
<button id="locationBtn">üìç Set / Update Location</button>
<p id="locStatus"></p>

<label>Your Services</label>
<div id="rolesBox">Loading‚Ä¶</div>

<button id="saveBtn">Save Changes</button>
<div id="msg"></div>
</div>
</main>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  doc, getDoc, setDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const mobileInput = document.getElementById("mobile");
const addressInput = document.getElementById("address");
const rolesBox = document.getElementById("rolesBox");
const msg = document.getElementById("msg");
const locationBtn = document.getElementById("locationBtn");
const locStatus = document.getElementById("locStatus");

let uid;
let userLocation = null;
let selectedRoles = [];

/* üîê Auth check */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href="login.html"; return; }
  uid = user.uid;
  emailInput.value = user.email;
  await loadProfile();
  await loadRoles();
});

/* üë§ Load profile */
async function loadProfile(){
  const snap = await getDoc(doc(db,"users",uid));
  if(!snap.exists()) return;
  const d = snap.data();
  nameInput.value = d.name || "";
  mobileInput.value = d.mobile || "";
  addressInput.value = d.address || "";
  selectedRoles = d.roles || [];
  if(d.location){
    userLocation = d.location;
    locStatus.innerText = "üìç Location saved";
  }
}

/* üß∞ Load roles */
async function loadRoles(){
  rolesBox.innerHTML="";
  const snap = await getDocs(collection(db,"primaryRoles"));
  snap.forEach(r=>{
    const role = r.data().roleName;
    const label = document.createElement("label");
    label.className="role";

    const cb = document.createElement("input");
    cb.type="checkbox";
    cb.checked = selectedRoles.includes(role);

    cb.onchange=()=>{
      if(cb.checked && !selectedRoles.includes(role))
        selectedRoles.push(role);
      if(!cb.checked)
        selectedRoles = selectedRoles.filter(x=>x!==role);
    };

    label.appendChild(cb);
    label.append(" " + role);
    rolesBox.appendChild(label);
  });
}

/* üìç Location */
locationBtn.onclick=()=>{
  if(!navigator.geolocation){
    locStatus.innerText="Not supported"; return;
  }
  locStatus.innerText="Fetching‚Ä¶";
  navigator.geolocation.getCurrentPosition(
    pos=>{
      userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
      locStatus.innerText="üìç Location updated";
    },
    ()=>locStatus.innerText="Permission denied",
    {timeout:5000}
  );
};

/* üíæ Save */
document.getElementById("saveBtn").onclick=async()=>{
  try{
    await setDoc(doc(db,"users",uid),{
      name:nameInput.value.trim(),
      mobile:mobileInput.value.trim(),
      address:addressInput.value.trim(),
      roles:selectedRoles,
      location:userLocation,
      updatedAt:Date.now()
    },{merge:true});
    msg.innerText="‚úÖ Profile updated";
  }catch(e){
    msg.innerText="‚ùå "+e.message;
  }
};
</script>

</body>
</html>
